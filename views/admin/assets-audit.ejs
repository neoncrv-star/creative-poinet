<%- include('layout-header') %>

<div class="admin-card" style="max-width: 1100px; margin: 0 auto;">
    <div class="card-header">
        <h2>تدقيق الأصول ومزامنتها</h2>
        <p>تحقق من الصور المرجعية في قاعدة البيانات وتأكد من وجود ملفاتها في مجلد /public/uploads. ارفع الملفات المفقودة بدقة حسب اسمها.</p>
        <div style="margin-top:10px; color:#aaa;">
            <span>الإجمالي: <strong><%= stats.total %></strong></span>
            <span style="margin:0 10px;">|</span>
            <span>المفقود: <strong style="color:#ff5555"><%= stats.missing %></strong></span>
        </div>
    </div>
    <div class="card-body" style="overflow:auto;">
        <table style="width:100%; border-collapse: collapse;">
            <thead>
                <tr style="border-bottom:1px solid #222;">
                    <th style="text-align:right; padding:8px;">الكيان</th>
                    <th style="text-align:right; padding:8px;">المعرف</th>
                    <th style="text-align:right; padding:8px;">الحقل</th>
                    <th style="text-align:right; padding:8px;">المسار</th>
                    <th style="text-align:right; padding:8px;">الحالة</th>
                    <th style="text-align:right; padding:8px;">رفع ملف بديل</th>
                </tr>
            </thead>
            <tbody>
                <% refs.forEach(r => { %>
                    <tr style="border-bottom:1px solid #111;">
                        <td style="padding:8px;"><%= r.type %></td>
                        <td style="padding:8px;">#<%= r.id %></td>
                        <td style="padding:8px;"><%= r.field %></td>
                        <td style="padding:8px; direction:ltr;"><%= r.value %></td>
                        <td style="padding:8px;">
                            <% if (r.isExternal) { %>
                                <span style="color:#00b894;">رابط خارجي</span>
                            <% } else if (r.exists) { %>
                                <span style="color:#27ae60;">موجود</span>
                                <small style="color:#888;">(<%= r.fileSize %>B)</small>
                            <% } else { %>
                                <span style="color:#ff5555;">مفقود</span>
                            <% } %>
                        </td>
                        <td style="padding:8px;">
                            <% if (!r.isExternal && !r.exists && r.value && r.value.startsWith('/uploads/')) { %>
                                <form action="/admin/assets/upload/<%= r.value.replace('/uploads/','') %>" method="POST" enctype="multipart/form-data" style="display:flex; gap:8px; align-items:center;">
                                    <input type="file" name="file" accept="image/*" required>
                                    <button type="submit" class="btn btn-primary">رفع إلى <%= r.value.replace('/uploads/','') %></button>
                                </form>
                            <% } else { %>
                                <span style="color:#666;">—</span>
                            <% } %>
                        </td>
                    </tr>
                <% }) %>
            </tbody>
        </table>
    </div>
</div>

<%- include('layout-footer') %>
