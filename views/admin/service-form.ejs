<%- include('layout-header') %>

<div class="admin-content-inner">
    <div class="admin-topbar-actions" style="margin-bottom: 2rem; display: flex; justify-content: space-between; align-items: center;">
        <h2 style="font-weight: 700; color: var(--secondary-color);"><%= service ? 'تعديل الخدمة' : 'إضافة خدمة جديدة' %></h2>
        <a href="/admin/services" class="btn btn-secondary" style="background: #eee; color: var(--text-main);">
            <i class="fas fa-arrow-right"></i> إلغاء والعودة
        </a>
    </div>

    <form action="/admin/services/<%= service ? 'edit/' + service.id : 'add' %>" method="POST" enctype="multipart/form-data">
        <div class="form-layout" style="display: grid; grid-template-columns: 2fr 1fr; gap: 2rem;">
            <div class="form-main-col">
                <div class="admin-card" style="margin-bottom: 1.5rem;">
                    <h3 style="margin-bottom: 1.5rem; color: var(--secondary-color); border-bottom: 1px solid #eee; padding-bottom: 10px;">
                        <i class="fas fa-layer-group"></i> بيانات الخدمة
                    </h3>

                    <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                        <div class="form-group">
                            <label>عنوان الخدمة (عربي)</label>
                            <input type="text" name="title_ar" value="<%= service ? service.title_ar : '' %>" required>
                        </div>
                        <div class="form-group">
                            <label>Service Title (English)</label>
                            <input type="text" name="title_en" value="<%= service ? service.title_en : '' %>" required>
                        </div>
                    </div>

                    <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                        <div class="form-group">
                            <label>وصف مختصر (عربي)</label>
                            <textarea name="description_ar" rows="4" required><%= service ? service.description_ar : '' %></textarea>
                        </div>
                        <div class="form-group">
                            <label>Short Description (English)</label>
                            <textarea name="description_en" rows="4" required><%= service ? service.description_en : '' %></textarea>
                        </div>
                    </div>

                    <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                        <div class="form-group">
                            <label>كلمات تسويقية (عربي)</label>
                            <input type="text" name="tag1_ar" value="<%= service ? service.tag1_ar : '' %>" placeholder="كلمة 1">
                            <input type="text" name="tag2_ar" value="<%= service ? service.tag2_ar : '' %>" placeholder="كلمة 2" style="margin-top: 8px;">
                            <input type="text" name="tag3_ar" value="<%= service ? service.tag3_ar : '' %>" placeholder="كلمة 3" style="margin-top: 8px;">
                        </div>
                        <div class="form-group">
                            <label>Marketing Keywords (English)</label>
                            <input type="text" name="tag1_en" value="<%= service ? service.tag1_en : '' %>" placeholder="Keyword 1">
                            <input type="text" name="tag2_en" value="<%= service ? service.tag2_en : '' %>" placeholder="Keyword 2" style="margin-top: 8px;">
                            <input type="text" name="tag3_en" value="<%= service ? service.tag3_en : '' %>" placeholder="Keyword 3" style="margin-top: 8px;">
                        </div>
                    </div>
                </div>

                <div class="admin-card">
                    <h3 style="margin-bottom: 1.5rem; color: var(--secondary-color); border-bottom: 1px solid #eee; padding-bottom: 10px;">
                        <i class="fas fa-search"></i> إعدادات SEO
                    </h3>

                    <div class="form-group">
                        <label>عنوان السيو (SEO Title)</label>
                        <input type="text" name="seoTitle" value="<%= service ? service.seoTitle : '' %>">
                    </div>
                    <div class="form-group">
                        <label>وصف السيو (Meta Description)</label>
                        <textarea name="seoDescription" rows="3"><%= service ? service.seoDescription : '' %></textarea>
                    </div>
                    <div class="form-group">
                        <label>كلمات مفتاحية</label>
                        <input type="text" name="seoKeywords" value="<%= service ? service.seoKeywords : '' %>" placeholder="كلمة1, كلمة2, كلمة3">
                    </div>
                </div>
            </div>

            <div class="form-side-col">
                <div class="admin-card" style="margin-bottom: 1.5rem;">
                    <h3 style="margin-bottom: 1.5rem; color: var(--secondary-color); border-bottom: 1px solid #eee; padding-bottom: 10px;">
                        <i class="fas fa-cog"></i> الإعدادات
                    </h3>
                    <div class="form-group">
                        <label>ترتيب العرض</label>
                        <input type="number" name="display_order" value="<%= service ? service.display_order : 0 %>">
                    </div>
                    <div class="form-group" style="display: flex; align-items: center; gap: 8px;">
                        <input type="checkbox" id="is_active" name="is_active" <%= !service || service.is_active ? 'checked' : '' %>>
                        <label for="is_active">إظهار الخدمة في الموقع</label>
                    </div>
                    <button type="submit" class="btn btn-primary btn-block" style="width: 100%; justify-content: center; padding: 1rem; margin-top: 1rem;">
                        <i class="fas fa-save"></i> <%= service ? 'حفظ التغييرات' : 'حفظ الخدمة' %>
                    </button>
                </div>

                <div class="admin-card">
                    <h3 style="margin-bottom: 1.5rem; color: var(--secondary-color); border-bottom: 1px solid #eee; padding-bottom: 10px;">
                        <i class="fas fa-image"></i> صورة الخدمة
                    </h3>

                    <% if (service && service.image) { %>
                        <div style="margin-bottom: 1rem; border: 1px solid #eee; border-radius: 8px; overflow: hidden;">
                            <img src="<%= assetPath(service.image) %>" alt="Service Image" style="width: 100%; height: auto; display: block;">
                        </div>
                    <% } else { %>
                        <div style="background: #f8f9fa; height: 150px; display: flex; align-items: center; justify-content: center; border: 2px dashed #ddd; border-radius: 8px; margin-bottom: 1rem; color: var(--text-muted);">
                            <i class="fas fa-image fa-3x"></i>
                        </div>
                    <% } %>

                    <div style="display: flex; flex-direction: column; gap: 8px;">
                        <label class="btn btn-outline" for="service-image" style="width: 100%; border: 2px dashed var(--primary-color); color: var(--primary-color); justify-content: center; cursor: pointer;">
                            <i class="fas fa-cloud-upload-alt"></i> اختر من جهازك
                            <input type="file" name="image" id="service-image" accept="image/*" style="display: none" onchange="updateServiceFileName(this)">
                        </label>
                        <button type="button" class="btn btn-secondary" style="justify-content: center;" onclick="openUploadsBrowser('service')" id="open-server-service-btn">
                            <i class="fas fa-folder-open"></i> اختيار من الخادم
                        </button>
                        <input type="hidden" name="existingImage" id="existingImageService" value="<%= service && service.image ? service.image : '' %>">
                        <div id="service-file-name" style="margin-top: 10px; font-size: 0.85rem; color: var(--primary-color); text-align: center;"></div>
                    </div>
                </div>

                <div class="admin-card">
                    <h3 style="margin-bottom: 1.5rem; color: var(--secondary-color); border-bottom: 1px solid #eee; padding-bottom: 10px;">
                        <i class="fas fa-align-left"></i> نص بديل للصورة (ALT)
                    </h3>
                    <div class="form-group">
                        <label>النص البديل (عربي)</label>
                        <input type="text" name="imageAlt_ar" value="<%= service && service.imageAlt_ar ? service.imageAlt_ar : '' %>" placeholder="وصف قصير للصورة يظهر لمحركات البحث والقارئات">
                    </div>
                    <div class="form-group">
                        <label>النص البديل (إنجليزي)</label>
                        <input type="text" name="imageAlt_en" value="<%= service && service.imageAlt_en ? service.imageAlt_en : '' %>" placeholder="Short English alt text for the service image">
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<div id="uploadsBrowserModal" class="admin-modal">
    <div class="modal-content" style="max-width: 800px;">
        <span class="close-modal" onclick="closeUploadsBrowser()">&times;</span>
        <h3 style="margin-bottom: 10px; color: var(--secondary-color);"><i class="fas fa-folder-open"></i> استعراض الصور على الخادم</h3>
        <div style="display: flex; gap: 8px; align-items: center; margin-bottom: 10px;">
            <input id="uploadsSearch" type="text" placeholder="ابحث بالاسم..." style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 8px;">
            <button class="btn" type="button" onclick="refreshUploads()">تحديث</button>
        </div>
        <div id="uploadsGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px; max-height: 60vh; overflow: auto;"></div>
    </div>
    <style>
        #uploadsGrid img{width:100%;height:100px;object-fit:cover;border-radius:8px;border:1px solid #eee}
        .upload-tile{cursor:pointer;position:relative}
        .upload-tile span{position:absolute;bottom:0;left:0;right:0;background:rgba(0,0,0,0.5);color:#fff;font-size:.75rem;padding:2px 4px;border-radius:0 0 8px 8px;direction:ltr}
    </style>
</div>

<script>
function updateServiceFileName(input) {
    var fileName = input.files[0] ? input.files[0].name : '';
    var el = document.getElementById('service-file-name');
    if (el) {
        el.textContent = fileName ? 'المحدد: ' + fileName : '';
    }
}

var uploadsTarget = null;
async function openUploadsBrowser(target) {
    uploadsTarget = target;
    var modal = document.getElementById('uploadsBrowserModal');
    if (modal) {
        modal.style.display = 'block';
    }
    await refreshUploads();
}
function closeUploadsBrowser() {
    var modal = document.getElementById('uploadsBrowserModal');
    if (modal) {
        modal.style.display = 'none';
    }
}
async function refreshUploads() {
    var searchInput = document.getElementById('uploadsSearch');
    var q = searchInput && searchInput.value ? searchInput.value.trim().toLowerCase() : '';
    var res = await fetch('/admin/uploads/list');
    var json = await res.json();
    var grid = document.getElementById('uploadsGrid');
    if (!grid) return;
    grid.innerHTML = '';
    (json.files || []).filter(function (f) {
        return !q || (f.name && f.name.toLowerCase().includes(q));
    }).forEach(function (f) {
        var div = document.createElement('div');
        div.className = 'upload-tile';
        div.onclick = function () { selectExistingImage(f.url); };
        div.innerHTML = '<img src="' + f.url + '" alt="' + (f.name || "") + '"><span>' + (f.name || "") + '</span>';
        grid.appendChild(div);
    });
}
function selectExistingImage(url) {
    if (uploadsTarget === 'service') {
        var hidden = document.getElementById('existingImageService');
        if (hidden) {
            hidden.value = url;
        }
        var el = document.getElementById('service-file-name');
        if (el) {
            var name = url.split('/').pop();
            el.textContent = 'المحدد: ' + name;
        }
    }
    closeUploadsBrowser();
}
</script>

<style>
@media (max-width: 992px) {
    .form-layout {
        grid-template-columns: 1fr !important;
    }
    .form-side-col {
        order: -1;
    }
}
</style>

<%- include('layout-footer') %>
