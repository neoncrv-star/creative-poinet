<%- include('layout-header') %>

<div class="admin-card" style="max-width: 1200px; margin: 0 auto;">
    <div class="card-header" style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px;">
        <div>
            <h2>إدارة الوسائط</h2>
            <p>استعرض جميع الوسائط المرتبطة بقاعدة البيانات (صور، فيديو، صوت)، واحذفها من الكيانات أو من الخادم عند عدم استخدامها.</p>
            <div style="margin-top:10px; color:#aaa; display:flex; gap:12px; flex-wrap:wrap;">
                <span>الإجمالي: <strong><%= stats.total %></strong></span>
                <span>الصور: <strong><%= stats.images %></strong></span>
                <span>الفيديو: <strong><%= stats.videos %></strong></span>
                <span>الصوت: <strong><%= stats.audios %></strong></span>
            </div>
        </div>
        <div style="display:flex; gap:8px; flex-wrap:wrap;">
            <a href="/admin/media" class="btn <%= !currentFilter ? 'btn-primary' : 'btn-secondary' %>">الكل</a>
            <a href="/admin/media?type=image" class="btn <%= currentFilter === 'image' ? 'btn-primary' : 'btn-outline' %>">الصور فقط</a>
            <a href="/admin/media?type=video" class="btn <%= currentFilter === 'video' ? 'btn-primary' : 'btn-outline' %>">الفيديو فقط</a>
            <a href="/admin/media?type=audio" class="btn <%= currentFilter === 'audio' ? 'btn-primary' : 'btn-outline' %>">الصوت فقط</a>
        </div>
    </div>
    <div class="card-body" style="overflow:auto;">
        <% if (!refs || !refs.length) { %>
            <p style="padding:16px;">لا توجد وسائط مسجلة حالياً في قاعدة البيانات.</p>
        <% } else { %>
            <table style="width:100%; border-collapse: collapse; font-size:0.9rem;">
                <thead>
                    <tr style="border-bottom:1px solid #222;">
                        <th style="text-align:right; padding:8px;">النوع</th>
                        <th style="text-align:right; padding:8px;">الكيان</th>
                        <th style="text-align:right; padding:8px;">المعرف</th>
                        <th style="text-align:right; padding:8px;">الحقل</th>
                        <th style="text-align:right; padding:8px;">المعاينة</th>
                        <th style="text-align:right; padding:8px;">المسار / الرابط</th>
                        <th style="text-align:right; padding:8px;">الحالة</th>
                        <th style="text-align:right; padding:8px;">الإجراءات</th>
                    </tr>
                </thead>
                <tbody>
                    <% refs.forEach(function(r){ %>
                        <tr style="border-bottom:1px solid #111;">
                            <td style="padding:8px;">
                                <% if (r.mediaKind === 'image') { %>
                                    <span style="color:#00b894;">صورة</span>
                                <% } else if (r.mediaKind === 'video') { %>
                                    <span style="color:#0984e3;">فيديو</span>
                                <% } else if (r.mediaKind === 'audio') { %>
                                    <span style="color:#e17055;">صوت</span>
                                <% } else { %>
                                    <span style="color:#b2bec3;">أخرى</span>
                                <% } %>
                            </td>
                            <td style="padding:8px;"><%= r.type %></td>
                            <td style="padding:8px;">#<%= r.entityId %></td>
                            <td style="padding:8px;"><%= r.field %></td>
                            <td style="padding:8px; min-width:140px;">
                                <% if (!r.isExternal && r.exists && r.mediaKind === 'image') { %>
                                    <img src="<%= assetPath(r.value) %>" alt="<%= r.title || r.field %>" style="width:120px; height:70px; object-fit:cover; border-radius:4px; border:1px solid #222;">
                                <% } else if (!r.isExternal && r.mediaKind === 'video') { %>
                                    <div style="display:flex;align-items:center;gap:6px;color:#0984e3;">
                                        <i class="fas fa-video"></i>
                                        <span>ملف فيديو</span>
                                    </div>
                                <% } else if (!r.isExternal && r.mediaKind === 'audio') { %>
                                    <div style="display:flex;align-items:center;gap:6px;color:#e17055;">
                                        <i class="fas fa-music"></i>
                                        <span>ملف صوت</span>
                                    </div>
                                <% } else { %>
                                    <span style="color:#636e72;">—</span>
                                <% } %>
                            </td>
                            <td style="padding:8px; direction:ltr; max-width:260px; word-break:break-all;">
                                <%= r.value %>
                            </td>
                            <td style="padding:8px;">
                                <% if (r.isExternal) { %>
                                    <span style="color:#00b894;">رابط خارجي</span>
                                <% } else if (r.exists) { %>
                                    <span style="color:#27ae60;">ملف موجود</span>
                                    <small style="color:#888;">(<%= r.fileSize %>B)</small>
                                <% } else { %>
                                    <span style="color:#ff5555;">ملف مفقود</span>
                                <% } %>
                            </td>
                            <td style="padding:8px;">
                                <% if (r.isExternal) { %>
                                    <span style="color:#666;">—</span>
                                <% } else { %>
                                    <form action="/admin/media/delete" method="POST" onsubmit="return confirm('سيتم إزالة هذا المسار من الكيان، وحذف الملف من الخادم إذا لم يكن مستخدماً في مكان آخر. هل أنت متأكد؟');" style="display:inline-flex; gap:6px; align-items:center;">
                                        <input type="hidden" name="type" value="<%= r.type %>">
                                        <input type="hidden" name="id" value="<%= r.entityId %>">
                                        <input type="hidden" name="field" value="<%= r.field %>">
                                        <input type="hidden" name="value" value="<%= r.value %>">
                                        <input type="hidden" name="filter" value="<%= currentFilter %>">
                                        <button type="submit" class="btn btn-danger" style="padding:4px 10px; font-size:0.8rem;">
                                            <i class="fas fa-trash-alt"></i>
                                            <span>حذف الوسيط</span>
                                        </button>
                                    </form>
                                <% } %>
                            </td>
                        </tr>
                    <% }) %>
                </tbody>
            </table>
        <% } %>
    </div>
</div>

<%- include('layout-footer') %>

